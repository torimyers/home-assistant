name: 🚀 Deploy to Home Assistant

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - '.github/**'
  workflow_dispatch:
    inputs:
      force_restart:
        description: 'Restart Home Assistant after deploy'
        type: boolean
        default: false

jobs:
  validate:
    name: Validate Before Deploy
    runs-on: self-hosted  # Changed from ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create test secrets
        run: |
          cp secrets.yaml.example secrets.yaml
          sed -i 's/your_.*_here/test_value/g' secrets.yaml
          sed -i 's/your_.*_password/test_password/g' secrets.yaml
          sed -i 's/your_.*_key/test_api_key_12345678901234567890123456789012/g' secrets.yaml
      - uses: frenck/action-home-assistant@v1.4
        with:
          path: "."

  deploy:
    name: Deploy Configuration
    needs: validate
    runs-on: self-hosted
    if: needs.validate.result == 'success'
    
    steps:
      - name: 📥 Check out repository
        uses: actions/checkout@v4
        
      # REMOVED: SSH Setup (not needed for local deployment)
      
      - name: 🚀 Deploy to Home Assistant (Local)
        run: |
          echo "🚀 Deploying configuration locally..."
          echo "Working directory: $(pwd)"
          echo "Target: /mnt/user/appdata/Home-Assistant-Container/"
          
          # List what we're deploying
          echo "Files to deploy:"
          ls -la
          
          # Copy files directly (no SSH - we're on the same machine)
          rsync -avz --delete \
            --exclude='.git*' \
            --exclude='secrets.yaml' \
            --exclude='secrets.yaml.example' \
            --exclude='README.md' \
            ./ /mnt/user/appdata/Home-Assistant-Container/
            
          echo "✅ Configuration deployed successfully"
          
      - name: 🔄 Reload HA Configuration
        run: |
          # Use localhost since we're on the same machine
          curl -X POST "http://localhost:8123/api/services/homeassistant/reload_core_config" \
            -H "Authorization: Bearer ${{ secrets.HA_TOKEN }}" \
            -H "Content-Type: application/json" \
            || echo "Core config reload failed"
            
          curl -X POST "http://localhost:8123/api/services/automation/reload" \
            -H "Authorization: Bearer ${{ secrets.HA_TOKEN }}" \
            -H "Content-Type: application/json" \
            || echo "Automation reload failed"
            
          echo "🔄 Configuration reload completed"
          
      - name: 🔁 Restart HA (if requested)
        if: github.event.inputs.force_restart == 'true'
        run: |
          docker restart Home-Assistant-Container || echo "Container restart failed"
          echo "🔁 Home Assistant restart initiated"