name: üöÄ Deploy to Home Assistant

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - '.github/**'
  workflow_dispatch:
    inputs:
      force_restart:
        description: 'Restart Home Assistant after deploy'
        type: boolean
        default: false

jobs:
  validate:
    name: Validate Before Deploy
    runs-on: self-hosted  # Changed from ubuntu-latest
    steps:
      - name: Clean workspace
        run: |
          # Force remove any problematic cache files
          sudo find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          sudo find . -name "*.pyc" -delete 2>/dev/null || true
          
      - uses: actions/checkout@v4
        with:
          clean: true
      - name: Create test secrets
        run: |
          cp secrets.yaml.example secrets.yaml
          sed -i 's/your_.*_here/test_value/g' secrets.yaml
          sed -i 's/your_.*_password/test_password/g' secrets.yaml
          sed -i 's/your_.*_key/test_api_key_12345678901234567890123456789012/g' secrets.yaml
      - uses: frenck/action-home-assistant@v1.4
        with:
          path: "."

  deploy:
    name: Deploy Configuration
    needs: validate
    runs-on: self-hosted
    if: needs.validate.result == 'success'
    
    steps:
      - name: Clean workspace  
        run: |
          # Force remove any problematic cache files
          sudo find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          sudo find . -name "*.pyc" -delete 2>/dev/null || true
          
      - name: üì• Check out repository
        uses: actions/checkout@v4
        with:
          clean: true
        
      # REMOVED: SSH Setup (not needed for local deployment)
      
      - name: üöÄ Deploy to Home Assistant (Local)
        run: |
          echo "üöÄ Deploying configuration locally..."
          echo "Working directory: $(pwd)"
          echo "Target: /mnt/user/appdata/Home-Assistant-Container/"
          
          # List what we're deploying
          echo "Files to deploy:"
          ls -la
          
          # Copy files directly (no SSH - we're on the same machine)
          sudo rsync -rlptD \
            --no-owner --no-group \
            --include='*.yaml' \
            --include='*.yml' \
            --include='automations/' \
            --include='automations/**' \
            --include='scenes/' \
            --include='scenes/**' \
            --include='scripts/' \
            --include='scripts/**' \
            --include='integrations/' \
            --include='integrations/**' \
            --include='customizations/' \
            --include='customizations/**' \
            --include='entities/' \
            --include='entities/**' \
            --include='blueprints/' \
            --include='blueprints/**' \
            --include='dashboards/' \
            --include='dashboards/**' \
            --include='themes/' \
            --include='themes/**' \
            --include='assistants/' \
            --include='assistants/**' \
            --exclude='*' \
            ./ /mnt/user/appdata/Home-Assistant-Container/
            
          echo "‚úÖ Configuration deployed successfully"
          
      - name: üîÅ Restart Home Assistant Container
        if: github.event.inputs.force_restart == 'true'
        run: |
          echo "üîÅ Restarting Home Assistant container..."
          
          # Find the Home Assistant container
          CONTAINER=$(docker ps --filter "name=Home-Assistant" --format "{{.Names}}" | head -1)
          
          if [ -z "$CONTAINER" ]; then
            echo "‚ùå Home Assistant container not found"
            echo "Available containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
            exit 1
          fi
          
          echo "Found container: $CONTAINER"
          
          # Restart the container
          if docker restart "$CONTAINER"; then
            echo "‚úÖ Container restart successful"
            echo "‚è≥ Waiting for Home Assistant to initialize..."
            sleep 30
          else
            echo "‚ùå Container restart failed"
            exit 1
          fi