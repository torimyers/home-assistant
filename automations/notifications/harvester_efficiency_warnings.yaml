---
# Harvester Efficiency Warning System - Spice Production Alerts
alias: "Harvester Efficiency Warning System"
description: "Intelligent harvester monitoring with production optimization alerts"
trigger:
  - platform: numeric_state
    entity_id: sensor.harvester_efficiency
    below: 70
    for:
      minutes: 8
    id: efficiency_warning
  - platform: numeric_state
    entity_id: sensor.harvester_efficiency
    below: 50
    for:
      minutes: 3
    id: efficiency_critical
  - platform: numeric_state
    entity_id: sensor.harvester_efficiency
    below: 30
    for:
      minutes: 1
    id: efficiency_emergency
  - platform: numeric_state
    entity_id: sensor.harvester_efficiency
    above: 90
    for:
      minutes: 10
    id: efficiency_optimal
  - platform: template
    value_template: >-
      {{ states('sensor.harvester_efficiency') | float < 60 and
         (now().hour >= 8 and now().hour <= 22) }}
    id: peak_hour_inefficiency
condition:
  - condition: state
    entity_id: input_boolean.notification_system_enabled
    state: "on"
action:
  - choose:
      # HARVESTER EMERGENCY - Production Failure
      - conditions:
          - condition: trigger
            id: efficiency_emergency
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "üö® HARVESTER EMERGENCY: Production Failure!"
              message: >-
                GUILD NAVIGATOR ALERT! The spice harvest fails catastrophically!
                
                ‚ö° **CRITICAL EFFICIENCY**: {{ states('sensor.harvester_efficiency') }}% - {{ state_attr('sensor.harvester_efficiency', 'efficiency_grade') }}
                üìâ **PRODUCTION STATUS**: EMERGENCY SHUTDOWN IMMINENT
                
                **Harvester Analysis:**
                ‚Ä¢ Current Load: {{ state_attr('sensor.harvester_efficiency', 'current_load') }}
                ‚Ä¢ Motion Activity: {{ state_attr('sensor.harvester_efficiency', 'motion_activity') }}
                ‚Ä¢ Peak Hours: {{ state_attr('sensor.harvester_efficiency', 'peak_hours') }}
                
                **Critical Impact Assessment:**
                ‚Ä¢ Spice Production: {{ states('sensor.spice_production_level') }} units ({{ state_attr('sensor.spice_production_level', 'current_yield') }})
                ‚Ä¢ Guild Rating: {{ state_attr('sensor.spice_production_level', 'guild_rating') }}
                ‚Ä¢ System Health Impact: {{ states('sensor.sietch_health_score') }}%
                
                üèúÔ∏è "He who controls the spice controls the universe. Your control slips away!"
                
                **EMERGENCY PROTOCOLS:**
                ‚Ä¢ Immediate harvester system review required
                ‚Ä¢ Check for mechanical failures or blockages
                ‚Ä¢ Verify power distribution and load balancing
                ‚Ä¢ Inspect motion sensor network integrity
                
                THE GUILD DEMANDS THE SPICE MUST FLOW! ACT IMMEDIATELY OR FACE THE CONSEQUENCES!
              data:
                actions:
                  - action: "HARVESTER_EMERGENCY_REPAIR"
                    title: "üîß Emergency Repair"
                  - action: "SPICE_PRODUCTION_OVERRIDE"
                    title: "‚ö° Production Override"
                  - action: "GUILD_NOTIFICATION"
                    title: "üì° Notify Guild"
                group: "harvester_emergency"
                tag: "harvester_critical"
                notification_icon: "mdi:factory-alert"
                color: "#8B0000"
                channel: "Harvester Alerts"
                importance: max
                sticky: true
                timeout: 0
                sound: "alarm_stream_max_4"

          - service: persistent_notification.create
            data:
              title: "üö® HARVESTER EMERGENCY ACTIVE"
              message: >-
                **CRITICAL SPICE PRODUCTION FAILURE**
                
                Efficiency: {{ states('sensor.harvester_efficiency') }}%
                Grade: {{ state_attr('sensor.harvester_efficiency', 'efficiency_grade') }}
                
                **THE SPICE MUST FLOW - IMMEDIATE ACTION REQUIRED**
                
                Time: {{ now().strftime('%H:%M:%S') }}
              notification_id: "harvester_emergency"

      # CRITICAL EFFICIENCY ALERT
      - conditions:
          - condition: trigger
            id: efficiency_critical
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "‚ö†Ô∏è CRITICAL: Harvester Efficiency Degraded"
              message: >-
                The spice harvest suffers, Muad'Dib. The Guild will notice such inefficiency.
                
                ‚ö° **Harvester Efficiency**: {{ states('sensor.harvester_efficiency') }}% - {{ state_attr('sensor.harvester_efficiency', 'efficiency_grade') }}
                üìä **Production Impact**: {{ states('sensor.spice_production_level') }} units ({{ state_attr('sensor.spice_production_level', 'current_yield') }})
                
                **Efficiency Analysis:**
                ‚Ä¢ System Load: {{ state_attr('sensor.harvester_efficiency', 'current_load') }}
                ‚Ä¢ Activity Zones: {{ state_attr('sensor.harvester_efficiency', 'motion_activity') }}
                ‚Ä¢ Peak Performance Window: {{ state_attr('sensor.harvester_efficiency', 'peak_hours') }}
                
                **Contributing Factors:**
                {% if (now().hour < 8 or now().hour > 22) %}‚Ä¢ Operating outside peak efficiency hours{% endif %}
                {% if state_attr('sensor.harvester_efficiency', 'current_load') | replace(' active devices', '') | int > 8 %}‚Ä¢ Excessive system load detected{% endif %}
                
                **Production Metrics:**
                ‚Ä¢ Current Guild Rating: {{ state_attr('sensor.spice_production_level', 'guild_rating') }}
                ‚Ä¢ Spice Yield Status: {{ state_attr('sensor.spice_production_level', 'current_yield') }}
                
                üèúÔ∏è "The desert provides, but only to those who respect its rhythms. Your harvesters struggle against natural patterns."
                
                **Corrective Actions:**
                ‚Ä¢ Optimize harvester load distribution
                ‚Ä¢ Review motion sensor network performance
                ‚Ä¢ Balance system resource allocation
                ‚Ä¢ Consider maintenance protocols
                
                The Guild watches. The Baron waits. Restore efficiency before competitors sense weakness.
              data:
                actions:
                  - action: "HARVESTER_DIAGNOSTICS"
                    title: "üîç Run Diagnostics"
                  - action: "OPTIMIZE_HARVESTER"
                    title: "‚öôÔ∏è Optimize Systems"
                  - action: "PRODUCTION_ANALYSIS"
                    title: "üìä Production Report"
                group: "harvester_alerts"
                tag: "harvester_critical"
                notification_icon: "mdi:factory-alert"
                color: "#E67E22"
                channel: "Harvester Alerts"
                importance: high
                sticky: true
                timeout: 1800

      # STANDARD EFFICIENCY WARNING
      - conditions:
          - condition: trigger
            id: efficiency_warning
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "‚ö†Ô∏è Harvester Efficiency Below Standards"
              message: >-
                Harvester performance declines, Duke. The spice flow requires attention.
                
                ‚ö° **Current Efficiency**: {{ states('sensor.harvester_efficiency') }}% - {{ state_attr('sensor.harvester_efficiency', 'efficiency_grade') }}
                üìà **Trend**: Below optimal operating parameters
                
                **Performance Metrics:**
                ‚Ä¢ Production Level: {{ states('sensor.spice_production_level') }} units
                ‚Ä¢ Current Yield: {{ state_attr('sensor.spice_production_level', 'current_yield') }}
                ‚Ä¢ Guild Rating: {{ state_attr('sensor.spice_production_level', 'guild_rating') }}
                
                **System Analysis:**
                ‚Ä¢ Device Load: {{ state_attr('sensor.harvester_efficiency', 'current_load') }}
                ‚Ä¢ Zone Activity: {{ state_attr('sensor.harvester_efficiency', 'motion_activity') }}
                ‚Ä¢ Optimal Hours: {{ state_attr('sensor.harvester_efficiency', 'peak_hours') }}
                
                üèúÔ∏è **Operation Guidance:**
                "Efficiency in spice production requires harmony between machine and desert rhythms."
                
                **Optimization Opportunities:**
                {% if (now().hour >= 8 and now().hour <= 22) %}‚Ä¢ Operating within peak hours - efficiency should be higher{% endif %}
                ‚Ä¢ Review current system load distribution
                ‚Ä¢ Optimize motion-based automation triggers
                ‚Ä¢ Consider harvester maintenance scheduling
                
                Maintain focus. The universe depends on the spice, and the spice depends on your vigilance.
              data:
                actions:
                  - action: "VIEW_EFFICIENCY_TRENDS"
                    title: "üìà View Trends"
                  - action: "OPTIMIZATION_GUIDE"
                    title: "üí° Optimization Tips"
                  - action: "SCHEDULE_MAINTENANCE"
                    title: "üîß Schedule Maintenance"
                group: "harvester_alerts"
                tag: "harvester_warning"
                notification_icon: "mdi:factory"
                color: "#F39C12"
                channel: "Harvester Alerts"
                importance: default
                sticky: false
                timeout: 1200

      # OPTIMAL EFFICIENCY ACHIEVEMENT
      - conditions:
          - condition: trigger
            id: efficiency_optimal
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "üèÜ Optimal Harvester Performance!"
              message: >-
                Magnificent, Muad'Dib! Your harvesters achieve Guild Navigator standards.
                
                ‚ö° **Peak Efficiency**: {{ states('sensor.harvester_efficiency') }}% - {{ state_attr('sensor.harvester_efficiency', 'efficiency_grade') }}
                üåü **Performance Grade**: {{ state_attr('sensor.harvester_efficiency', 'efficiency_grade') }}
                
                **Production Excellence:**
                ‚Ä¢ Spice Production: {{ states('sensor.spice_production_level') }} units
                ‚Ä¢ Yield Status: {{ state_attr('sensor.spice_production_level', 'current_yield') }}
                ‚Ä¢ Guild Recognition: {{ state_attr('sensor.spice_production_level', 'guild_rating') }}
                
                **Operational Mastery:**
                ‚Ä¢ System Load Optimization: Excellent
                ‚Ä¢ Motion Synchronization: {{ state_attr('sensor.harvester_efficiency', 'motion_activity') }}
                ‚Ä¢ Peak Hour Utilization: Maximized
                
                üèúÔ∏è **Guild Commendation**: "Your harvesters move with the desert's rhythm. The spice flows as Shai-Hulud intended."
                
                **Benefits of Peak Performance:**
                ‚Ä¢ Enhanced spice production output
                ‚Ä¢ Improved system-wide efficiency ratings
                ‚Ä¢ Reduced mechanical stress and maintenance needs
                ‚Ä¢ Guild favor and trading advantages
                
                {% if states('sensor.harvester_efficiency') | float >= 95 %}
                üåü **LEGENDARY ACHIEVEMENT**: Harvester efficiency exceeds even the most optimistic Guild projections!
                {% endif %}
                
                The desert recognizes mastery. Your domain prospers under such excellence.
              data:
                actions:
                  - action: "VIEW_PEAK_PERFORMANCE"
                    title: "üìä Performance Report"
                  - action: "GUILD_COMMENDATION"
                    title: "üèÖ Guild Report"
                  - action: "MAINTAIN_EXCELLENCE"
                    title: "‚öôÔ∏è Maintain Standards"
                group: "achievements"
                tag: "harvester_optimal"
                notification_icon: "mdi:trophy"
                color: "#27AE60"
                channel: "Achievements"
                importance: default
                sticky: false
                timeout: 900

      # PEAK HOUR INEFFICIENCY ALERT
      - conditions:
          - condition: trigger
            id: peak_hour_inefficiency
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "‚è∞ Peak Hour Inefficiency Detected"
              message: >-
                The prime harvest hours waste away, Duke. This inefficiency costs valuable spice production.
                
                ‚ö° **Current Efficiency**: {{ states('sensor.harvester_efficiency') }}%
                ‚è∞ **Peak Hours Active**: {{ state_attr('sensor.harvester_efficiency', 'peak_hours') }}
                
                **Lost Opportunity Analysis:**
                ‚Ä¢ Expected Efficiency: 85-95% during peak hours
                ‚Ä¢ Current Performance: {{ state_attr('sensor.harvester_efficiency', 'efficiency_grade') }}
                ‚Ä¢ Production Impact: {{ state_attr('sensor.spice_production_level', 'current_yield') }}
                
                üèúÔ∏è "Time is the fire in which we burn. Do not waste the precious daylight hours when the desert offers its greatest gifts."
                
                **Immediate Optimization:**
                ‚Ä¢ Review current system load
                ‚Ä¢ Optimize motion-triggered operations
                ‚Ä¢ Reduce non-essential energy consumption
                
                Seize the peak hours. The desert will not offer this efficiency window again until tomorrow.
              data:
                actions:
                  - action: "PEAK_HOUR_OPTIMIZATION"
                    title: "‚ö° Optimize Now"
                  - action: "VIEW_PEAK_ANALYSIS"
                    title: "üìä Peak Analysis"
                group: "harvester_alerts"
                tag: "peak_inefficiency"
                notification_icon: "mdi:clock-alert"
                color: "#9B59B6"
                channel: "Harvester Alerts"
                importance: default
                sticky: false
                timeout: 900

mode: queued
max: 10
max_exceeded: silent