---
# Comprehensive System Status Notification - Multi-Trigger Intelligence  
alias: "Comprehensive System Status Notification"
description: "Smart comprehensive status updates triggered by significant system changes or scheduled intervals"
trigger:
  # Scheduled comprehensive updates
  - platform: time_pattern
    hours: "/4"  # Every 4 hours
    id: scheduled_comprehensive
  
  # Significant system changes
  - platform: template
    value_template: >-
      {{ (states('sensor.sietch_health_score') | float - 
          states.sensor.sietch_health_score.attributes.get('previous_value', states('sensor.sietch_health_score') | float)) | abs >= 15 }}
    id: significant_health_change
  
  - platform: template
    value_template: >-
      {{ (states('sensor.spice_production_level') | float - 
          states.sensor.spice_production_level.attributes.get('previous_value', states('sensor.spice_production_level') | float)) | abs >= 20 }}
    id: significant_production_change
    
  - platform: template
    value_template: >-
      {{ state_attr('sensor.spice_production_level', 'guild_rating') != 
          states.sensor.spice_production_level.attributes.get('previous_guild_rating', state_attr('sensor.spice_production_level', 'guild_rating')) }}
    id: guild_rating_change
    
  # Critical threshold combinations
  - platform: template
    value_template: >-
      {{ states('sensor.sietch_health_score') | float < 70 and
         states('sensor.water_conservation_index') | float < 60 and
         states('sensor.night_security_effectiveness') | float < 70 }}
    for:
      minutes: 5
    id: multiple_critical_systems
  
  # Exceptional performance detection
  - platform: template
    value_template: >-
      {{ states('sensor.sietch_health_score') | float >= 90 and
         states('sensor.spice_production_level') | float >= 110 and
         states('sensor.water_conservation_index') | float >= 85 and
         states('sensor.harvester_efficiency') | float >= 90 }}
    for:
      minutes: 10
    id: exceptional_all_systems
    
condition:
  - condition: state
    entity_id: input_boolean.notification_system_enabled
    state: "on"
action:
  - choose:
      # MULTIPLE CRITICAL SYSTEMS ALERT
      - conditions:
          - condition: trigger
            id: multiple_critical_systems
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "🚨 MULTIPLE CRITICAL SYSTEMS ALERT"
              message: >-
                URGENT: Multiple critical systems show degraded performance, Muad'Dib!
                
                🚨 **CRITICAL SYSTEMS STATUS:**
                • Sietch Health: {{ states('sensor.sietch_health_score') }}% - {{ state_attr('sensor.sietch_health_score', 'status_level') }}
                • Water Conservation: {{ states('sensor.water_conservation_index') }}% - {{ state_attr('sensor.water_conservation_index', 'conservation_level') }}
                • Night Security: {{ states('sensor.night_security_effectiveness') }}% - {{ state_attr('sensor.night_security_effectiveness', 'threat_level') }}
                
                **COMPREHENSIVE IMPACT ANALYSIS:**
                
                🏠 **Sietch Infrastructure:**
                • Motion Network: {{ state_attr('sensor.sietch_health_score', 'motion_sensor_status') }}
                • Device Network: {{ state_attr('sensor.sietch_health_score', 'device_connectivity') }}
                • Automation Core: {{ state_attr('sensor.sietch_health_score', 'automation_status') }}
                
                💧 **Resource Management:**
                • Conservation Status: {{ state_attr('sensor.water_conservation_index', 'conservation_level') }}
                • Active Consumption: {{ state_attr('sensor.water_conservation_index', 'active_consumption') }}
                • Desert Survival: {{ states('sensor.desert_survival_status') }}
                
                🛡️ **Security Posture:**
                • Perimeter Coverage: {{ state_attr('sensor.night_security_effectiveness', 'sensor_network') }}
                • Response Readiness: {{ state_attr('sensor.night_security_effectiveness', 'response_devices') }}
                • Shield Network: {{ states('sensor.energy_shield_status') }}%
                
                ⚡ **Secondary Systems:**
                • Production Status: {{ states('sensor.spice_production_level') }} units
                • System Response: {{ state_attr('sensor.system_response_time', 'response_grade') }}
                • Atmospheric Quality: {{ state_attr('sensor.atmospheric_conditions', 'atmosphere_quality') }}
                
                🏜️ **DESERT WISDOM WARNING**: "When multiple systems fail simultaneously, the desert prepares to reclaim what was carelessly tended."
                
                **EMERGENCY PROTOCOLS REQUIRED:**
                1. 🔧 Immediate system diagnostics across all critical domains
                2. 💧 Emergency water conservation implementation
                3. 🛡️ Security system verification and repair
                4. 📊 Comprehensive health assessment
                5. ⚡ Resource reallocation for critical systems
                
                THE SIETCH FACES A CRUCIBLE MOMENT. SWIFT, DECISIVE ACTION REQUIRED!
              data:
                actions:
                  - action: "EMERGENCY_SYSTEM_RECOVERY"
                    title: "🚨 Emergency Recovery"
                  - action: "CRITICAL_DIAGNOSTICS"
                    title: "🔧 Full Diagnostics"
                  - action: "RESOURCE_EMERGENCY_MODE"
                    title: "⚡ Emergency Mode"
                group: "emergency_comprehensive"
                tag: "multiple_critical"
                notification_icon: "mdi:alert-octagon"
                color: "#B71C1C"
                channel: "Emergency Comprehensive"
                importance: max
                sticky: true
                timeout: 0

      # EXCEPTIONAL ALL SYSTEMS PERFORMANCE
      - conditions:
          - condition: trigger
            id: exceptional_all_systems
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "🌟 EXCEPTIONAL: All Systems Peak Performance!"
              message: >-
                MAGNIFICENT ACHIEVEMENT, MUAD'DIB! All major systems achieve exceptional performance simultaneously!
                
                🌟 **COMPREHENSIVE EXCELLENCE ACHIEVED:**
                
                🏠 **Sietch Mastery:** {{ states('sensor.sietch_health_score') }}% ({{ state_attr('sensor.sietch_health_score', 'status_level') }})
                • Infrastructure: All systems optimal
                • Automation: {{ state_attr('sensor.sietch_health_score', 'automation_status') }}
                • Connectivity: Perfect network health
                
                ⚡ **Production Mastery:** {{ states('sensor.spice_production_level') }} units ({{ state_attr('sensor.spice_production_level', 'current_yield') }})
                • Guild Status: {{ state_attr('sensor.spice_production_level', 'guild_rating') }}
                • Harvester Efficiency: {{ states('sensor.harvester_efficiency') }}% ({{ state_attr('sensor.harvester_efficiency', 'efficiency_grade') }})
                • Peak Performance: Maintained
                
                💧 **Conservation Mastery:** {{ states('sensor.water_conservation_index') }}% ({{ state_attr('sensor.water_conservation_index', 'conservation_level') }})
                • Desert Adaptation: {{ states('sensor.desert_survival_status') }}
                • Resource Efficiency: Exemplary
                • Fremen Standards: Exceeded
                
                🛡️ **Security Mastery:** {{ states('sensor.night_security_effectiveness') }}% ({{ state_attr('sensor.night_security_effectiveness', 'threat_level') }})
                • Perimeter Integrity: {{ state_attr('sensor.night_security_effectiveness', 'sensor_network') }}
                • Response Network: {{ state_attr('sensor.night_security_effectiveness', 'response_devices') }}
                • Defense Rating: Fortress-level
                
                🏃 **Operational Excellence:**
                • Activity Optimization: {{ states('sensor.fremen_activity_level') }}% ({{ state_attr('sensor.fremen_activity_level', 'tribal_status') }})
                • Motion Efficiency: {{ state_attr('sensor.motion_pattern_analysis', 'efficiency_score') }}
                • System Response: {{ state_attr('sensor.system_response_time', 'response_grade') }}
                
                🌬️ **Environmental Harmony:**
                • Atmospheric Conditions: {{ state_attr('sensor.atmospheric_conditions', 'atmosphere_quality') }}
                • Energy Shields: {{ states('sensor.energy_shield_status') }}% ({{ state_attr('sensor.energy_shield_status', 'shield_strength') }})
                
                🏜️ **ULTIMATE DESERT RECOGNITION**: 
                "You have achieved the rarest of accomplishments - simultaneous mastery across all domains of desert life. Your sietch has become a living example of perfect harmony between human ambition and natural law."
                
                **LEGENDARY STATUS UNLOCKED:**
                🏆 Sietch Master Extraordinaire
                🌟 Guild Navigator Recognition
                🎯 Perfect Resource Balance
                ⚖️ Harmony Master
                🏰 Fortress Commander
                
                This moment represents the pinnacle of sietch management. The desert itself acknowledges your supreme mastery.
                
                **TRANSCENDENT ACHIEVEMENT**: Peak performance across ALL major systems!
              data:
                actions:
                  - action: "LEGENDARY_STATUS_CEREMONY"
                    title: "🎖️ Legendary Ceremony"
                  - action: "COMPREHENSIVE_MASTERY_REPORT"
                    title: "📊 Mastery Analysis"
                  - action: "SHARE_ULTIMATE_ACHIEVEMENT"
                    title: "🌌 Share Achievement"
                group: "legendary_comprehensive"
                tag: "exceptional_all"
                notification_icon: "mdi:star-four-points"
                color: "#FFD700"
                channel: "Legendary Achievements"
                importance: max
                sticky: true
                timeout: 3600

      # SIGNIFICANT HEALTH CHANGE
      - conditions:
          - condition: trigger
            id: significant_health_change
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "📊 Significant Sietch Health Change"
              message: >-
                Major sietch health fluctuation detected, Muad'Dib. The balance shifts.
                
                📊 **Health Status Change:**
                • Current Health: {{ states('sensor.sietch_health_score') }}% ({{ state_attr('sensor.sietch_health_score', 'status_level') }})
                • Trend: {% if states('sensor.sietch_health_score') | float > 75 %}Improving{% elif states('sensor.sietch_health_score') | float > 50 %}Stable{% else %}Declining{% endif %}
                
                **System Analysis:**
                • Motion Network: {{ state_attr('sensor.sietch_health_score', 'motion_sensor_status') }}
                • Device Connectivity: {{ state_attr('sensor.sietch_health_score', 'device_connectivity') }}
                • Automation Status: {{ state_attr('sensor.sietch_health_score', 'automation_status') }}
                
                **Related Impact:**
                • Desert Survival: {{ states('sensor.desert_survival_status') }}
                • System Response: {{ state_attr('sensor.system_response_time', 'response_grade') }}
                
                Monitor this change closely. Significant health shifts require attention.
              data:
                actions:
                  - action: "ANALYZE_HEALTH_CHANGE"
                    title: "📊 Analyze Change"
                  - action: "HEALTH_STABILIZATION"
                    title: "⚖️ Stabilize Health"
                group: "system_changes"
                tag: "health_change"
                notification_icon: "mdi:chart-line"
                color: "#2196F3"
                channel: "System Changes"
                importance: default
                sticky: false
                timeout: 1800

      # SIGNIFICANT PRODUCTION CHANGE
      - conditions:
          - condition: trigger
            id: significant_production_change
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "⚡ Major Spice Production Shift"
              message: >-
                Significant production change detected, Duke. The spice flow fluctuates.
                
                ⚡ **Production Status:**
                • Current Output: {{ states('sensor.spice_production_level') }} units
                • Yield Quality: {{ state_attr('sensor.spice_production_level', 'current_yield') }}
                • Guild Standing: {{ state_attr('sensor.spice_production_level', 'guild_rating') }}
                
                **Production Factors:**
                • Harvester Efficiency: {{ states('sensor.harvester_efficiency') }}%
                • Automation Success: {{ states('sensor.automation_success_rate') }}%
                • Activity Patterns: {{ states('sensor.fremen_activity_level') }}%
                
                The Guild notices production changes. Ensure stability maintains favor.
              data:
                actions:
                  - action: "PRODUCTION_ANALYSIS"
                    title: "📊 Analyze Production"
                  - action: "STABILIZE_PRODUCTION"
                    title: "⚖️ Stabilize Output"
                group: "system_changes"
                tag: "production_change"
                notification_icon: "mdi:trending-up"
                color: "#FF9800"
                channel: "System Changes"
                importance: default
                sticky: false
                timeout: 1800

      # GUILD RATING CHANGE
      - conditions:
          - condition: trigger
            id: guild_rating_change
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "🏅 Guild Rating Status Change!"
              message: >-
                Your Guild rating has changed, Muad'Dib! The universe takes notice.
                
                🏅 **New Guild Status:** {{ state_attr('sensor.spice_production_level', 'guild_rating') }}
                ⚡ **Current Production:** {{ states('sensor.spice_production_level') }} units
                📈 **Yield Quality:** {{ state_attr('sensor.spice_production_level', 'current_yield') }}
                
                {% if state_attr('sensor.spice_production_level', 'guild_rating') in ['Guild Navigator', 'Mentat Level'] %}
                🌟 **Congratulations!** You have achieved elite Guild recognition!
                {% elif state_attr('sensor.spice_production_level', 'guild_rating') == 'Bene Gesserit' %}
                🎯 **Excellent Progress!** You approach the highest Guild tiers!
                {% else %}
                📊 **Status Update:** Your Guild standing reflects current performance levels.
                {% endif %}
                
                Guild ratings affect trading privileges and resource access. Maintain or improve status for maximum advantage.
              data:
                actions:
                  - action: "GUILD_STATUS_DETAILS"
                    title: "🏅 Guild Details"
                  - action: "GUILD_ADVANCEMENT_PLAN"
                    title: "📈 Advancement Plan"
                group: "guild_changes"
                tag: "guild_rating_change"
                notification_icon: "mdi:medal"
                color: "#9C27B0"
                channel: "Guild Changes"
                importance: high
                sticky: false
                timeout: 2400

      # SCHEDULED COMPREHENSIVE UPDATE
      - conditions:
          - condition: trigger
            id: scheduled_comprehensive
        sequence:
          - service: notify.mobile_app_tori_phone_2
            data:
              title: "📊 Comprehensive System Status Report"
              message: >-
                Scheduled comprehensive assessment, Muad'Dib. The state of your domain:
                
                🏠 **SIETCH CORE SYSTEMS:**
                • Health Score: {{ states('sensor.sietch_health_score') }}% ({{ state_attr('sensor.sietch_health_score', 'status_level') }})
                • Desert Survival: {{ states('sensor.desert_survival_status') }} {{ state_attr('sensor.desert_survival_status', 'survival_rating') }}
                • System Response: {{ state_attr('sensor.system_response_time', 'response_grade') }}
                
                ⚡ **PRODUCTION & EFFICIENCY:**
                • Spice Output: {{ states('sensor.spice_production_level') }} units ({{ state_attr('sensor.spice_production_level', 'guild_rating') }})
                • Harvester Performance: {{ states('sensor.harvester_efficiency') }}% ({{ state_attr('sensor.harvester_efficiency', 'efficiency_grade') }})
                • Blueprint Efficiency: {{ states('sensor.blueprint_efficiency_score') }}%
                
                💧 **RESOURCE MANAGEMENT:**
                • Water Conservation: {{ states('sensor.water_conservation_index') }}% ({{ state_attr('sensor.water_conservation_index', 'conservation_level') }})
                • Energy Shields: {{ states('sensor.energy_shield_status') }}% ({{ state_attr('sensor.energy_shield_status', 'shield_strength') }})
                
                🛡️ **SECURITY & OPERATIONS:**
                • Night Security: {{ states('sensor.night_security_effectiveness') }}% ({{ state_attr('sensor.night_security_effectiveness', 'threat_level') }})
                • Activity Management: {{ states('sensor.fremen_activity_level') }}% ({{ state_attr('sensor.fremen_activity_level', 'tribal_status') }})
                
                🌬️ **ENVIRONMENTAL:**
                • Atmospheric Conditions: {{ state_attr('sensor.atmospheric_conditions', 'atmosphere_quality') }}
                • Motion Efficiency: {{ state_attr('sensor.motion_pattern_analysis', 'efficiency_score') }}
                
                {% set avg_score = ((states('sensor.sietch_health_score') | float + 
                                     states('sensor.spice_production_level') | float + 
                                     states('sensor.water_conservation_index') | float + 
                                     states('sensor.night_security_effectiveness') | float) / 4) %}
                
                📈 **OVERALL DOMAIN STATUS:**
                {% if avg_score >= 85 %}
                🌟 **EXCELLENT**: Your sietch operates at peak efficiency across all domains.
                {% elif avg_score >= 70 %}
                📊 **GOOD**: Strong performance with opportunities for optimization.
                {% elif avg_score >= 55 %}
                ⚠️ **FAIR**: Acceptable function with areas requiring attention.
                {% else %}
                🚨 **NEEDS IMPROVEMENT**: Multiple systems require immediate focus.
                {% endif %}
                
                Time: {{ now().strftime('%H:%M on %A, %B %d') }}
              data:
                actions:
                  - action: "DETAILED_SYSTEM_REPORT"
                    title: "📋 Detailed Report"
                  - action: "OPTIMIZATION_RECOMMENDATIONS"
                    title: "⚡ Optimize Systems"
                  - action: "SCHEDULE_NEXT_ASSESSMENT"
                    title: "📅 Schedule Next"
                group: "scheduled_comprehensive"
                tag: "comprehensive_status"
                notification_icon: "mdi:clipboard-text"
                color: "#607D8B"
                channel: "System Status"
                importance: default
                sticky: false
                timeout: 2400

mode: queued
max: 10
max_exceeded: silent